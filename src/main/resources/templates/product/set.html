<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/product/set.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 350,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
    <style>
        .nav-top>.nav-left {

            width: 550px;

            background-image: url("/img/img_logo_main.png");
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
        }

        .nav-bottom>.nav-right {
            background-image: url("/img/TeemoPC.jpg");
            background-repeat: no-repeat;
            background-size: 220px;
            background-position: center;
            width: 340px;
            height: 95px;
        }
    </style>
</head>

<body>
    <div>
        <header>
            <div class="header-top">
                <div class="header-left">
                    <ul>
                        <li style="width: 50px;" class="header-home"><a href="/product/index" class="material-symbols-outlined "
                                style="font-size: 22px;">home</a></li>
                        <li><a href="">PC구매상담</a></li>
                        <li><a href="/user/login">로그인</a></li>
                    </ul>
                </div>
                <div class="header-right">
                    <ul>
                        <li><a href="">다나와</a></li>
                        <li><a href="">에누리</a></li>
                        <li><a href="">몰테일</a></li>
                        <li style="width: 100px;"><a href="">플레이오토</a></li>
                        <li style="width: 85px;"><a href="">메이크샵</a></li>
                    </ul>
                </div>
            </div>
        </header>
        <nav class="nav-top">
            <div class="nav-left"></div>
            <div class="nav-center">
                <div class="search">
                    <input type="text" class="form-control" placeholder="검색어를 입력하세요">
                    <span class="material-symbols-outlined search-icon">search</span>
                </div>
            </div>
            <div class="nav-right" >
                <a th:if="${#authorization.expression('hasRole(''ROLE_MEMBER'')')} or ${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" class="material-symbols-outlined prod-icon" href="/product/set" >inventory_2</a>
                <a th:unless="${#authorization.expression('hasRole(''ROLE_MEMBER'')')} or ${#authorization.expression('hasRole(''ROLE_ADMIN'')')}"  class="material-symbols-outlined cart-icon">shopping_cart</a>

                <a th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" class="material-symbols-outlined key-icon" href="/product/keyword/set">key</a>
                <a th:unless="${#authorization.expression('hasRole(''ROLE_MEMBER'')')} or ${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" class="material-symbols-outlined heart-icon">heart_plus</a>

                <a th:if="${#authorization.expression('hasRole(''ROLE_MEMBER'')')} or ${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" class="material-symbols-outlined logout-icon" href="/logout">logout</a>
                <a th:unless="${#authorization.expression('hasRole(''ROLE_MEMBER'')')} or ${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" class="material-symbols-outlined login-icon" href="/user/login">person</a>
            </div>
        </nav>
        <!--  -->
        <section style="">
            <div style="display: flex; justify-content: center;">
                <h1 style="font-size: 30px;">상품 등록</h1>
            </div>
            <!-- ----------------------- form ------------------------------ -->
            <form id="product-set-form" action="/product/set" method="post" enctype="multipart/form-data">
                <article style="">
                    <ul>
                        <li class="goods-user">
                            <p style="padding-right: 50px;">작성자</p>
                            <div>
                                <input type="text" name="prodauthor" id="form-author" th:value="${#authentication.name}" readonly>
                            </div>
                        </li>
                        <!-- -------------- 제목 ---------------- -->
                        <li class="goods-name">
                            <p>제목</p>
                            <input type="text" name="prodname" id="form-title">
                        </li>
                        <!-- -------------- 내용 ---------------- -->
                        <li class="goods-text">
                            <p>내용</p>
                            <input type="text" name="prodcontext" id="form-text">
                        </li>
                        <!-- -------------- 가격 ---------------- -->
                        <li class="goods-money">
                            <p>가격</p>
                            <div>
                                <input type="text">
                            </div>
                        </li>
                        <!-- -------------- 콤보박스 ---------------- -->
                        <li class="goods-chck">
                            <p>제품 종류</p>
                            <div>
                                <select name="prodtype" id="form-select">
                                    <option value="option1">CPU</option>
                                    <option value="option2">그래픽카드</option>
                                    <option value="option3">메인보드</option>
                                    <option value="option4">SSD</option>
                                    <option value="option5">HDD</option>
                                    <option value="option6">메모리</option>
                                    <option value="option7">케이스</option>
                                    <option value="option8">파워</option>
                                </select>
                            </div>
                        </li>
                        <!-- -------------- 사진 ---------------- -->
                        <li class="goods-pict">
                            <p class="pict-left">사진</p>
                            <div class="pict-center" id="pict-center">
                            </div>
                        </li>
                        <li class="pict-right">
                            <input type="file" name="files" id="form-image-input" multiple>
                        </li>
                    </ul>
                </article>
                <div>
                    <button>등록</button>
                </div>
            </form>
        </section>
        <aside></aside>
        <footer>

        </footer>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js" integrity="sha512-uMtXmF28A2Ab/JJO2t/vYhlaa/3ahUOgj1Zf27M5rOo8/+fcTUVH0/E0ll68njmjrLqOBjXM3V9NiPFL5ywWPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>

        //전역 폼데이터
        let formData = new FormData();
        //메인 이미지 인덱스 저장용
        let selected;



        //미리보기가 생성될 위치
        const set_previewEl = document.getElementById('pict-center');
        //폼 데이터 받아오기
        const product_set_form = document.getElementById('product-set-form')

        //폼 전송
        product_set_form.addEventListener('submit', function(){
            event.preventDefault()
            //원본 formData
            getformData = new FormData(product_set_form);

            // getformData에서 복사할 키들
            let keynames = ['prodname', 'prodcontext','prodtype','prodauthor'];

            // getformData에서 값을 가져와서 전역formData로 복사
            for (let key of keynames) {
            let value = getformData.get(key);
            if (value !== null) {
             formData.append(key, value);
             };
          };

          //만약 메인 이미지 선택을 했을경우
          //다시다 꺼내서 순서를 새로 맞춰준다.
          if(!(selected==undefined)){

            const imgs = formData.getAll('files');
            formData.delete('files');

            formData.append('files', imgs[selected]);

            for(let i=0;i<imgs.length;i++){
                if(i == selected){

                }else{
                    formData.append('files',imgs[i]);
                }
            };

          };



            //완성된 formData 를 서버로 전송
            axios.post('/product/set',formData,{headers: {'Content-Type' : 'multipart/form-data' }})
                .then(response =>{
                    alert("ok")
                    window.location.href="/product/index";
                } )
                .catch(error =>{alert("fail");
                location.reload();
                });


        })

        //이미지 업로드
        document.getElementById('form-image-input').addEventListener('change', function(imgput){

            const imgFiles = imgput.target.files;

        for(let i=0;i<imgFiles.length;i++){
            formData.append('files',imgFiles[i])
        }

           //이미지 프리뷰 생성 시작
           getpreview();


        });

          //이미지 프리뷰 생성
        const getpreview = () => {

            const imgs = formData.getAll('files');
            for(let i=0;i<imgs.length;i++){

                var preview = document.createElement('div');
                preview.className = 'previews';
                preview.style.width = '150px';
                preview.style.height = '150px';
                preview.style.position = 'relative';

                var cutimg = document.createElement('a')
                cutimg.className = 'cutimgs';
                cutimg.href = "javascript:void(0)";
                cutimg.style.position = 'absolute';
                cutimg.style.top = '5%';
                cutimg.style.right = '5%';
                cutimg.style.border = '2px solid red';
                cutimg.style.width = '5px';
                cutimg.style.height = '5px';

                var viewimg = document.createElement('img');
                viewimg.className = 'view-img';
                viewimg.style.width = '150px';
                viewimg.style.height = '150px';

                preview.appendChild(viewimg);
                preview.appendChild(cutimg);
                set_previewEl.appendChild(preview);

            }

            //업로드 이미지를 불러오기 시작
            onreaderimg();
            //메인 이미지 선택 리스너 시작
            selectMainimgListener();
            //이미지 제외 리스너 시작
            cutimgListener();
        }

        //업로드 이미지를 불러오기
        //혼자 비동기로 돌아가서 이미지 프리뷰 틀 생성과 개별적으로 동작함
        const onreaderimg = ()  => {
    <!--        const formData = new FormData(product_set_form);-->
            const imgs = formData.getAll('files');
            const viewimgEl = document.querySelectorAll('.view-img');

            viewimgEl.forEach((imgno,index)=>{

                const reader = new FileReader();

                reader.readAsDataURL(imgs[index]);
                reader.onload = function(item){

                imgno.setAttribute('src',item.target.result);

                }

            })

        }


        //이미지 제외 리스너
        const cutimgListener = ()=> {

            const cutimgEl = document.querySelectorAll('.cutimgs');
            cutimgEl.forEach((item,index)=>{

                item.addEventListener('click',function(){
                    console.log(index+"번째 이미지 클릭됨!");
                    const imgs = formData.getAll('files');


                    formData.delete('files');


                    for(let i=0;i<imgs.length;i++){

                        console.log("index = "+index+" i = "+i);

                        if(!(index == i)){
                        console.log("index = "+index+" i = "+i+"통과");
                            formData.append('files',imgs[i]);
                        }

                    }

                    const oldpreviews = document.querySelectorAll('.previews');
                    oldpreviews.forEach(preview => {
                    preview.parentNode.removeChild(preview);
                    });

                    getpreview();

                })

            });

        }

        //메인 이미지 선택 리스너
        const selectMainimgListener = () => {
            const viewimgEl = document.querySelectorAll('.view-img');


            viewimgEl.forEach((item,index)=>{
                item.addEventListener('click',function(){
                    console.log(index+"번째 이미지 선택됨!");

                    selected = index;

                        viewimgEl.forEach((item,index)=>{
                        if(index == selected){
                            item.style.border = '5px solid green';
                        }else{
                            item.style.border = '1px solid black';
                        }

                    });

                });

            });



        };




    </script>
</body>

</html>